<!DOCTYPE html>
<html>
<head>
  <title>Plaid Sandbox Test</title>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>
<body>
  <button id="link-button">Connect Bank</button>
  <!-- <button id="connect-accounts">Connect Accounts</button> -->
  <button id="sync-button">Sync All Transactions</button>
  <div id="output"></div>

  <script>
    let accessToken = "access-sandbox-b379a0dc-85ba-4b4e-8f2d-8761dd8fb6da";

    fetch('http://localhost:8000/link-token')
      .then(res => res.json())
      .then(data => {
        const handler = Plaid.create({
          token: data.link_token,
          onSuccess: function(public_token, metadata) {
            console.log("Public token received: ", public_token);

            // Send public_token to backend
            fetch('http://localhost:8000/exchange-token', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                public_token: public_token,
                institution_name: metadata.institution?.name || "Unknown Bank",
              })
            })
            .then(res => res.json())
            .then(data => {
              console.log("Exchange token response: ", data);
              accessToken = data.access_token;
              console.log("Access token to be sent:", accessToken);
            });
          }
        });
        document.getElementById('link-button').onclick = () => handler.open();
      });

      // sync button
      document.getElementById("sync-button").addEventListener("click", () => {
        // fetch("http://localhost:8000/sync-transactions", {
        //   method: "POST",
        //   headers: {"Content-Type": "application/json" },
        //   body: JSON.stringify({
        //     access_token: accessToken,
        //     // cursor: cursor
        //   })
        // })
        // .then(res => res.json())
        // .then(data => {
        //   console.log("Transactions sync result: ", data);
        //   document.getElementById("output").textContent = JSON.stringify(data.added, null, 2);
        // })
        // .catch(err => console.log("Error syncing: ", err));
        fetch("http://localhost:8000/sync-all-transactions", { method: "POST" })
      })
  </script>
</body>
</html>